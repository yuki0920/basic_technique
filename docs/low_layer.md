# 低レイヤ用語集

## 参考

- [Goならわかるシステムプログラミング](https://www.lambdanote.com/products/go)
- [［試して理解］Linuxのしくみ](https://gihyo.jp/book/2022/978-4-297-13148-7)
- [なるほどUnixプロセス](https://tatsu-zine.com/books/naruhounix)
- [ふつうのLinuxプログラミング](https://www.sbcr.jp/product/4797386479/)
- [プログラムはなぜ動くのか](https://www.nikkeibp.co.jp/atclpubmkt/book/07/P83150/)
- [イラストでわかる DockerとKubernetes](https://gihyo.jp/book/2020/978-4-297-11837-2)

## OS
- OSは、ハードウェアを直接操作し、アプリケーションやミドルウェアの実行に必要な機能を提供するプログラムのこと
- デバイスドライバは、OSがデバイスを操作するために提供しているプログラムで、プロセスからはデバイスドライバを通してデバイスにアクセスする。略してドライバとも呼ぶ
- カーネルは、特権(カーネルモード)で動作するOSの核となる処理をまとめたプログラムのことで、デバイス操作、プロセス管理システム、プロセススケジューラ、メモリ管理システムを提供する
- 特権モードは、システム内のすべてのプロセスが共有するリソースを一元管理するためのモードであり、カーネルのみが動作できる
- マルチコアCPUは、Linuxからは1つのコアが1つのCPUとして認識される
- 論理CPUは、システムに1つのCPUとして認識されるCPUのこと

## CPU
- CPU(Central Processing Unit)はコンピュータにおける中心的な処理装置(プロセッサ)のこと
- CPUは制御装置、演算装置、データを一時記憶するレジスタ、メモリなどの記憶装置とのインタフェース、周辺機器との入出力装置とのインタフェースなどから構成される
- CPUは1つにつき、1プロセスが実行される
- CPUには、動作モードが存在し、OSが動作する特権モードと、アプリケーションが動作するユーザーモードがある
- レジスタは、処理対象となる命令やデータを格納する領域で一種のメモリーのようなもので、1つのCPUに数10個存在する
- アキュムレータ(eax)は、演算に使う値を格納するレジスタのこと
- プログラムカウンタ(ecx)は、次に実行する命令のアドレスを格納するレジスタのこと
- ベースレジスタ(ebx)は、インデックスレジスタは、アドレスを格納する
- ベースポインタ(ebp)はスタック格納一の起点となるポインタで、スタックポインタ(esp)はスタックの最上段のポインタ
- クロックは、CPUが動作するタイミングとなるクロック信号を発生させるもの
- プロセッサステータスワード(PSW)は、CPUの状態を表すレジスタのことで、モードや優先度、命令実行状態を持つ
- proc構造体は、プロセスごとに1つ割り当てられ、常にカーネルから必要とされる情報を扱う。常にメモリに常駐する
- user構造体はプロセスがオープンしたファイルやカレントディレクトリ情報を扱う。スワップの対象となる
- テキストセグメントは、プロセスに割り当てられるメモリ領域で、プログラムの命令列である機械語が格納される
- データセグメントは、プロセスに割り当てられるメモリ領域で、プログラムで使用される変数などが格納される

## システムコール
- システムコールは、アプリケーションからCPUの特権モードでOSの機能を呼ぶ機能のことで、メモリ割り当てやファイル入出力、ネットワーク通信、プロセス間通信等ができる
- システムコールが発行されると、CPUのモードがユーザーモードから特権モードに遷移し、依頼に応じたカーネルの処理が開始される
- POSIXとは、OS共通のシステムコールのIEEE規格で、システムコールを呼び出すためのインターフェースが定めされている。C言語の関数名と引数、返り値が定義されている。
- libcは標準Cライブラリであり、CPUのアーキテクチャごと(x86_64, arm64, etc...)にシステムコールのラッパー関数を提供している
- straceはシステムコール発行のログを出力するコマンド

## プロセス
- プロセスとは、実行ファイルを読み込み実行するためのリソース(メモリ、CPU)をまとめたプログラムの実行単位のこと
- プロセスに含まれるものは、実行ファイルパス、各種ID(プロセスID等)、カレントフォルダ、ファイルディスクリプタがある
- プロセスには入力があり、プログラムが処理し最後にの出力を行う。入力は、コマンドライン引数、環境変数があり、出力は、終了コードがある
- プロセス生成の目的は、「同じプログラムから複数のプロセスを生成する」と「まったく別のプロセスを生成する」こと
- プロセスは親プロセスで使われている全てのメモリのコピーと親プロセスが開いているすべてのファイルディスクリプタを引き継ぐ
- プロセスのライフサイクルは、fork(2)2で開始し、場合によってはexec(2)で別プロセスに変わり、wait(2)で親プロセスは子プロセスを待ち、exit(3)で終了する
- コピーオンライトは、子プロセスは親プロセスとメモリアドレスを共有し、参照しているメモリが書き込まれる場合に、参照しているメモリをコピーして書き込まれる機構
- プロセススケジューラ(ディスパッチャ)とは、複数プロセスを同時に動作させるためのカーネルの機構で、プロセスにいつタイムスライスを与えるかを管理している
- コンテキストスイッチとは、CPUが複数のプロセスを実行する場合にタイムスライスごとにプロセスを切り替えること。ラウンドロビン方式で実行している
- プロセスの状態には、実行状態(CPU使用中)、実行待ち状態(CPU割り当て待ち)、スリープ状態(イベント発生待ち)、ゾンビ状態(親プロセス終了待ち)がある
- 孤児プロセスとは、親プロセスが死んでも生きたままの子プロセスのこと
- 子プロセスは、並行処理に活用でき、子守りプロセス、マスター/ワーカー、preforkなどど呼ばれる
- ゾンビプロセスとは、親プロセスに待たれずに死んだ子プロセスのことで、内部的にはプロセステーブルにデータが残った状態。
- ゾンビプロセスは、長期実行されるデーモンプロセスの子プロセスがゾンビプロセスになるとリソースが逼迫する
- デーモンとは、バックグラウンドプロセスを作るための機構である。普通のプログラムはシェルの子プロセスになるため、ログアウトなどによってプロセスが終了してしまう
- ログは、デーモンプロセスが制御端末を持たず標準入出力が使えないためのメッセージの出力先である
- タスク、ジョブは定義が曖昧であるが、プロセス、スレッドを1つの単位やグループ単位で表現するもの
- クレデンシャルは、プロセスの属性としてのユーザーで、カーネルが管理している
- ログインは、その過程でクレデンシャルをもつプロセスが生成される
- セッションは、ユーザのログインからログアウトまでの流れを管理する概念で、ログインシェルを起点にユーザーが同じ端末から起動したプロセスを1つにまとめる機構
- プロセスグループは、パイプで繋がれたプロセス郡のこと
- サーバーは、プロセスになにかのサービスを提供するプロセスのこと
- systemdはブート時にカーネルが直接起動するプログラムで、すべてのプロセスの始まり
- 端末(ターミナル)は、ストリームの始端・終端を担う機器で、PC上では仮想端末としてターミナルやiTerm2がある
- シェルは、ユーザからの命令を解釈して実行するプログラム
- コマンドラインは、端末上でシェルを実行する環境のこと
- 環境変数は、プロセスの親子関係を通じてでんぱするグローバス変数のようなものß
- sed-uidプログラムは、コマンドを実行する際に、特定のユーザーの権限で実行するための機構

## スレッド
- スレッドとは、１つのプロセスの中で処理を実行する単位のことで、プロセスと異なり1CPUを専有するわけではない
- スレッドは、メモリ空間を共有できるため、プロセス間通信機構を使うことなく直接データを共有できるため高速である
- プログラムから見たスレッドは、メモリにロードされたプログラムの現在の実行状態を持つ仮想CPU
- OS、CPUからみたスレッドは、時間が凍結されたプログラムの実行状態
- スレッドは、OSによってタイムスライスごとに復元され実行される。CPUは前の処理が使っていたレジスタメモリを退避し、もともと使っていた状態にレジスタを復元するため、タスク切換えのコストがかかる
- (マルチ)スレッドセーフとは、マルチスレッドを同時実行しても問題が発生しないことを意味し、特にスレッドが共有メモリへアクセスする場合に気をつける必要がある

## シグナル
- シグナルとは、プロセスに対して送られるもの
- シグナルのプロセス間通信は、カーネルが仲介して、プロセスからプロセスにシグナルを送る
- シグナルのソフトウェア割り込みは、システムで発生したイベントがシグナルとしてプロセスに送られ、プロセスは予め用意したシグナルに対応するルーチンが強制的に実行される
- グレースフルリスタートとは、新しいサーバーを起動して新しいリクエストを流しつつ、古いサーバーのリクエストが完了したら正しく終了させるための機構。Server::Starterによって実現可能で、シグナルと環境変数によって実装されている

## デバイスアクセス
- デバイスファイルは、Linux上で動作しているハードウェアデバイスを表現したファイルで、カーネルがデバイスへアクセスするためのファイル
- デバイスファイルには、キャラクタデバイスとブロックデバイスがある
- キャラクタデバイスは、端末(ターミナル)、キーボード、マウスなどがある
- ブロックデバイスは、SSD、HDDなどがあり、ファイルの読み書き以外に、シークができる
- デバイスドライバは、レジスタを介して要求をデバイスに伝達するための、カーネルの機能
- マウントは、ブロックデバイスのファイルシステムを、システム上で利用可能にする機構
- デバイスファイルには、対応デバイスがないものがあり、/deb/nullなどが含まれる

## ブロック層
- ブロック層は、ブロックデバイス(ストレージデバイス)を扱うための機構
- I/Oスケジューラは、ブロックデバイスへのアクセス要求を一定期間ため、マージとソートにより最適化処理する機構
- readaheadは、ブロックデバイスへの読み出しを先読みしてページキャッシュに保存する機構
- スループットは、単位時間あたりのデータ転送量のことであり、大きなデータのコピーなどで意識される
- IOPS(I/O per second)は、1秒間に処理できるI/Oの数のことであり、1並列の場合はスループットの逆数となる
- レイテンシは、1回あたりのI/Oに要する時間のことであり、細かいI/Oが多く発生するときに意識される

## ファイルシステム
- ファイルシステムは、OSが提供するデータの格納場所、空き領域の場所を管理する機構。
- ファイルシステムによって、Linuxはストリームをファイルとして扱っている
- ファイルシステムは、データとメタデータ(ファイル名、位置、サイズ等)の2種類のデータがある
- ファイルシステムは、ストレージの領域を固定長のデータの配列として扱っている
- ファイルシステムは1ファイル領域として、管理情報(inode)とファイルの中身を持つ
- ディレクトリは、配下のファイル名とそのinodeのインデックスの一覧表が格納されている特別なファイル
- ディレクトリエントリは、ディレクトリの配下の1つのファイルは構造体のこと
- シンボリックリンクは、他のファイルの名前を格納したファイル
- ジャーナリングは、ファイルシステムにおける不整合防止の機構のこと
- ジャーナリングは、ジャーナルファイルというトランザクションログファイルを用意し、このファイルに基づいて操作をする
- ネットワークファイルシステムは、リモートにあるファイルをローカルからファイルシステムとして操作する機構
- ファイルディスクリプタは、OSがカーネルのレイヤーで用意している抽象化の機構で、ファイルの識別子である
- ファイルディスクリプタによって、ファイル以外にも、標準入出力、ソケットなどをファイルのようにアクセスできるようになる
- ファイルディスクリプタは、プロセスによって生成され、プロセスの破棄と同時に捨てられる
- OSはプロセスが起動すると、3つの疑似ファイルを作成し、ファイルディスクリプタの0に標準入力、1に標準出力、2に標準エラー出力を割り当てる
- ファイルディスクリプタが1つのプロセスに割り当てられる上限数は、カーネルごとにリミットとして定められている
- パイプは、プロセス間通信の手段で、ストリームの両端にプロセスがあり単方向にデータを流す
- pipe(2)は、両端とも自プロセスにつながったストリームを作成し、その両端のファイルディスクリプタ2つを返す
- ロックとは、ファイル等のリソースに対して複数のプロセス間で同時に変更しないようにするための仕組みで、共有ロックと排他ロックがある

## ストリーム
- ストリームは、カーネルを介してファイルとプロセス間を流れるバイト列の通り道で、readまたはwriteで操作できるもののこと
- IOストリームは、開始と終了の概念を持たずにパイプに行うデータ読み書きのことで、デリミタによって区切られる
- IOとはデータの入出力のことで、ファイルの読み出し書き込み(ディスクI/O)、ネットワーク通信(ネットワークI/O)のこと
- ストリームのシステムコール用の関数は、成功なら0以上の整数を返し、失敗なら-1を返す
- バッファとは、一時的にデータを保存しておく場所
- バッファの書き出しは、バッファが一杯になれば書き出されるが、ストリームの先に端末があれば改行('\n')が書き込まれるか、アンバッファドモードの場合は即時で、出力先が標準エラー出力の場合は即時でwriteが実行される
- バッファリングとは、バッファを経由してデータをやりとりすること
- バッファオーバーフローとは、バッファをはみ出して使うバグで、意図しないエラーが発生する
- open(2)はストリームを作り、read(2)でバッファにバイト列を読み込み、write(2)でバッファにバイト列を書き込み、close(2)で始末する
- getc(3)はストリームから1バイトを読み込み、putc(3)はストリームにバイト列を書き込む
- fflush(3)は、バッファリングした内容を即座にwrite(2)させる
- getopt(3)はコマンドラインオプションを解析する

## ネットワーク、ソケット
- サーバープロセスは、接続を待ちなにかの処理をするプロセス
- クライアントプロセスは、サーバーに接続してなにかの処理依頼をするプロセス
- ソケットは、socket(2)でストリームを作成し、クライアント側では、connect(2)でサーバーに接続する、サーバー側では、bind(2)でソケットを接続待ちアドレスに割り当てlisten(2)で接続待ち用のソケットであることをカーネルに伝達し、accept(2)でクライアント接続を待ち接続済みの新しいソケットを返す
- ソケットは、ストリームを繋げられるインターフェース
- ソケットとは、アプリケーション層からトランスポート層のプロトコルを利用するときのAPIのことで、プロセス間通信の1つ。アプリケーションがソケットを利用してデータの送受信要求をすると、OSが(TCP/IP等による)通信を行う
- ソケットの種類には、TCP、UDP、UNIXドメインソケット等がある
- ソケットは、一度接続が確立したら、親プロセスがclose(2)しても、子プロセス全てがclose(2)しない限り接続は維持される
- 並行サーバーとは、accept(2)した後fork(2)するサーバーのことで、シンプルwに運用できる
- プリフォークサーバーとは、fork(2)した後子プロセスでaccept(2)するサーバーのことで、パフォーマンスは良いが運用が複雑になる

## メモリ
- メモリは、揮発性の記憶デバイスのこと
- メモリは1つのプロセスごとに割り当てられる
- 仮想記憶は、プロセスから物理アドレスに仮想アドレスを用いてアクセスする方法
- メモリ管理ユニット(MMU)は、仮想メモリと物理メモリとマッピングするための機構で、ページテーブルという階層型のデータ構造によって実現している
- メモリは、カーネル用のメモリとプロセス用のメモリと空きメモリがある
- メモリは、不足した場合に優先度の低いメモリ領域の開放->スワップ->OOM Killerの順で確保される
- mmap(2)は、仮想メモリ機構のインターフェースで、メモリを確保する
- OOM Kilerとは、メモリの空き容量がないために、メモリ管理システムによって強制的に適当なプロセスを強制終了する機構
- メモリマップトファイル(ファイルマップ)は、ファイルの領域を仮想アドレス空間上にメモリマップする機構
- メモリマップとファイルはmmap()によって呼び出し、データを変更した場合はflushで書き戻す
- スワップ(ページング)は、物理メモリが枯渇した場合に、ストレージの一部をメモリとして利用する機構
- ヒュージページは、通常より大きい単位のページテーブルで、仮想メモリを多く使うプロセスに対して、ページテーブルが使用するメモリ量を減らすことができる
- キャッシュメモリは、CPUとメモリの間に配置され、メモリより高速な読み書きができる機器
- アドレス空間には、テキスト領域、データ領域、BSS領域、ヒープ領域、スタック領域がある
- ヒープは、動的に確保、開放できるメモリ領域。1つの関数でしか参照されない変数などが展開される
- malloc(3)は、カーネルからある程度メモリのヒープ領域確保する、free(3)でヒープ領域を開放する
- プロセスは、exit(3)によって終了し、同時に確保していたメモリが開放される
- 動的なメモリ確保は、malloc()などを使って、プログラムの実行時にメモリ割当をすることで、静的なメモリ確保はビルド時に、メモリサイズを決定すること
- スタックは、固定量のメモリ領域。関数の返り値として定義された変数などが展開される。
- alloc(3)は、スタック領域から動的のメモリ確保をする際に利用する

## コンピューター
- コンピューターアーキテクチャは、機械語を中心としたコンピュータの設計方式のこと
- X86は、コンピュータアーキテクチャの1つで、X86-64は、最大64ビット整数を表現できるアーキテクチャ
- 32ビットのCPUは、情報を出力するためのピンを32本持っており、一度に32桁(4バイト)の2進数の情報を処理できる
- UNIXエポックとは、1970/01/01 00:00のことで、この日時からの経過秒数のこと
- オブジェクトファイルは、ソースコードをコンパイラがコンパイルした結果生成される機械語のデータのこと
- 実行可能ファイルは、オブジェクトファイルをリンクして実行可能な形式となったファイルのこと
- プログラムのビルドは、プリプロセス、コンパイル、アセンブル、リンク順に行われる
- コンパイルは、ソースコードをアセンブリ言語に変換することで、オブジェクトファイルが生成される
- リンクは、複数のオブジェクトファイルを結合して実行可能ファイルを生成する処理のこと
- アセンブルは、アセンブリ言語のソースコードを機械語(マシン語、ネイティヴコード、バイナリコード)をオブジェクトファイルに変換すること
- 逆アセンブルは、ネイティヴコードをアセンブリ言語に変換すること
- リンクは、オブジェクトファイルから実行可能ファイルを生成すること
- アセンブリ言語は機械語(マシン語)命令に、動作を表す英語のような略語(ニーモニック)を割り当てた命令郡
- データ型は、メモリを専有するサイズを表現する単位
- ポインタは、データの値ではなく、データが格納されているメモリーのアドレスを持つ変数
- スタック、キューは、アドレスを指定せずに配列の要素を読み書きできる領域、データ―構造のこと
- ローカル変数は、スタック、レジスタを使って一時的に用意する値であり、使用後破棄するため、関数内部でしか利用できない
- BIOSは、プログラムの動作環境であり、コンピュータ起動時にブートストラップローダプログラムを起動し、OS(カーネル)をメモリに読み込み実行する

## インタプリタ言語
- 字句解析(Lexical Analysis)は、ソースコード内のテキストを読み込み、意味のある単語列トークン列へ変換すること
- 構文解析(Parse)は、トークン列を意味のある単位である単位にグループ化すること
- 構文解析器(Parser Generator)は、構文解析を行うプログラム
- Rubyのコードは、字句解析器によってトークン列が変換され、トークン列は構文解析器によってASTに変換され、コンパイラ(YARV)によってYARV命令列に変換される
- Ripperは、字句解析結果のトークン列を確認できるツールのこと
- Yacc,Bisonは、構文解析器の一種
- LALRは、構文解析器のアルゴリズムで、トークン列のストリームを左から右に処理し、定義した文法規則と一致した文法規則を返却する
- 抽象構文木(AST)は、構文解析によって得られる、データ構造  のこと
- YARVは、仮想のスタックマシンであり、ASTノードを低級な命令(YARV命令列)へ変換する
- ローカルテーブルは、変数や引数をあつかうためのデータ構造
- 制御フレーム構造体は、YARVの内部スタックの構造体であり、プログラムカウンタ、スタックポインタ、レシーバ、フレームタイプ(メソッド、ブロック等)を持つ
- 環境ポインタは、変数への動的アクセスを可能にするための基点
- 補足テーブルは、親のpopへのポインタを含んだテーブルで、ポインタの移動に使われる
- VMは、中間言語に生成するためのプログラムで、C言語等のエコシステムを利用し移植性を高められる
- ガベージコレクション(GC)は、オブジェクトへのメモリ割り当て、解放、参照の確認をするプログラム
- マークスイープは、GCの方式の1つで、ヒープ領域が使い切られたタイミングでオブジェクトへの参照を確認し、参照されている場合はマークし、されていなければ開放(スイープ)する仕組み

## コンテナ
- 仮想化機能はホスト上で仮想マシンを動作させるための機能のこと
- 仮想化マシンのプロセスは、ホストOSからは1つのプロセスとして動作している
- 仮想マシンは、ハードウェアとOSの間にハイパーバイザと呼ばれる管理層をはさみ、ハイパーバイザが提供する仮想的なハードウェア上で複数のOSを同時に動作できるようにする技術のこと
- 仮想マシンは専用のハードウェアとカーネルを使うのに対し、コンテナはホストOSと全コンテナがホストのカーネルを共有する
- コンテナは、CPU、メモリ、I/O、ネットワーク、ホスト名、TCPのポート番号がホスト環境から隔離されたアプリケーションの実行環境のこと
- コンテナは、仮想マシンと異なり環境ごとのOSは不要であるため軽量である

## Docker
- Dockerは、cgroupやnamespaceを利用して実現されている
- namespaceは、プロセスごとのCPU,メモリのリソース割り当てを制御することができる機構のこと
- Dockerのレイヤは、変更差分の集まりのこと
- Dockerはコンテナの実行時にtarに格納されているレイヤを重ね合わせることでルートファイルシステムを構築し、その上でコンテナを実行している
- DockerはDockerfileの各命令を実行するたび、レイヤをキャッシュしながらビルドを進める
- Storage Driverは、レイヤをルートファイルシステムとして構築する、レイヤ郡の管理を担うコンポーネント
- 高レベル(CRI)ランタイムは、kubeletやユーザー等から支持を受け、コンテナやイメージ、ネットワークの管理機能を提供するソフトウェアのこと
- 低レベル(OCI)ランタイムはホストから隔離された実行環境をコンテナとして作り出したり、その直接操作の手段を提供するソフトウェアのこと
- Dockerデーモンは、OCIランタイムを使ってコンテナ環境を作り出している
- cgroupは、システムのメモリやCPUなどのリソースをどのプロセスにどれだけ与えるかという細かい制御をする機能
- cgroupは、1つのシステムを複数ユーザーで共有したいクラウドサービスプロバイダにとって需要が高い機能である

## Kubernetes
- Kubernetesは、複数マシンからなる基板上でコンテナ軍を管理するのに用いられるオーケストレーションツールのこと
- Kubernetesのコントローラーは、管理用のAPIを参照操作(kubectl)しつつ、ユーザーが宣言した利用状態を維持するための具体的な管理作業を行うコンポ―ネント軍のこと
- Kubernetesにおいて、コンテナ郡を実行するマシンをクラスタ、コンテナが実行されるマシンをノード、アプリケーションをPod、その管理をDeploymentと呼ぶ
