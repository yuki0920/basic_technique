## Oauth2.0

### OAuthとは
- OAuth2.0は、サードパーティーアプリケーションへの限定的なアクセスを可能にする認可フレームワーク(アクセストークンの発行方法のルール)のこと
- OAuthが必要な理由は、サードパーティーアプリにユーザー名、パスワードを保存する必要がなくなること
- ロールを主体として、トークンやエンドポイントの関連を理解することが重要である

### OAuthのロール
- リソースオーナーは、リソースの所有者のこと
- クライアントは、アクセストークンを用いいリソースサーバーにアクセスするアプリケーションのこと
- リソースサーバーは、Web APIを通してリソースを提供するサーバーのこと
- 認可サーバーは、リソースオーナーを認証し、リソースのアクセス権の同意を得て、アクセストークンを発行し、クライアントへ返却するサーバーのこと

###  OAuthのトークン
- OAuthのトークンは、アクセストークン、リフレッシュトークン、認可コードが有り、認可サーバーからクライアントへ発行(付与)される
- Bearerトークンは、トークンの所有のみで決定されるセキュリティートークンで、送信元を確認しない
- アクセストークンは、リソースの所有者と、リソースアクセス権をコントロールするためのスコープと、有効期限が紐付いたトークンのこと
- リフレッシュトークンは、クライアントから認可サーバーに対してアクセストークンの再発行を要求する際に利用するトークンのこと
- 認可コード(トークン)は、リソースオーナーが―クライアントへの権限移譲に同意した証明としてのトークンのことで、アクセストークンの発行のために一度だけ利用できる

###  OAuthのエンドポイント
- 認可エンドポイントは、認可サーバーによって提供され、認可コードの発行を担う
- トークンエンドポイントは、認可サーバーによって提供され、アクセストークンの発行を担う
- リダイレクトエンドポイント(リダイレクトURI)は、クライアントによって提供され、リソースオーナーの認証後に認可サーバーからクライアントへリダイレクトする際に認可コードをクエリパラメーターに付与する役割を担う

### OAuthのグラントタイプ
- コンフィデンシャルクライアントは、クライアントID、クライアントシークレットを安全に保持できるクライアントのことで、サーバーサイドアプリケーションが該当する
- パブリッククライアントは、クライアントID、クライアントシークレットを安全に保持できないクライアントのことで、JavaScriptアプリケーションが該当する
- グラントタイプとは、アクセストークンを付与するための各ロール間のやりとりの方法で、クライアントのタイプごとに異なっている
- 認可(オーソリゼーション)コードグラントは、サーバー内にクライアントIDとクライアントシークレットを保存することを前提にした方式で、アクセストークンがブラウザを介さずクライアントと認可サーバーの間でやりとりされるためセキュアである
- インプリシットグラントは、クライアントにクライアントIDとクライアントシークレットをセキュアに保存できない方式で、クライアントサイドのアプリ(SPAなど)のセキュリティを確保するのに適し、OpenID Connectで拡張して利用されている
- クライアントクレデンシャルグラントは、クライアントと認可サーバー間だけのやりとりによる方式
- リソースオーナーパスワードクレデンシャルグランドは、リソースサーバー、認可サーバー、クライアントがすべて同じ提供元である場合に利用できる方式で、クライアントにユーザー名とパスワードを入力する(クライアントに保存はしない)

### OAuth認証
- OAuth認証とは、リソースサーバーが返却するプロフィール情報を、クライアントが認証に利用する方法のこと
- クライアントにサインイン、ログインする際に、認可サーバーがリソースオーナーの認証を行う
- OAuth認証の脆弱性は、インプリシットグラントにおいて、誰でもBearerのアクセストークンを利用して、リソースサーバーになりすましてアクセスできる点

## OpenID Connect(OIDC)
- OIDCは、OAuthを認証に拡張した仕様で、OAuthにIDトークンとUserInfoエンドポイントを加えたもの
- IDトークンは、JWT形式で発行され、RPでエンドユーザーの認証に使用され、ユーザーIDや発行日時、期限、署名が関連づいている
- UserInfoエンドポイントは、OIDCに準拠してIdPならば統一の規格であり、エンドユーザーの識別子(sub)などを返却する

### OIDCとOAuthのロールの関係(OIDC/OAuth)
- エンドユーザー/リソースオーナー
- リライングパーティ(RP)/クライアント
- IDプロパイダー(IdP)/認可サーバー

### OIDCとOAuthのフローの関係(OIDC/OAuth)
- 認可コードフローは、OAuthの認可コードグラントと同様
- インプリシットフローは、OAuthのインプリシットグラントと同様
- ハイブリッドフローは、認可コードフローとインプリシットフローのハイブリットはフローで、パブリッククライアントとコンフィデンシャルクライアントの両方で構成されているクライアントに向く
## Auth0
- Auth0は、認証のプラットフォームである
- IDaasとしての利点は、自前で認証基盤を用意しなくて良いため、開発コストを抑えられる、流出リスクが低くできる

## JWT
- JWTはヘッダ、ペイロード、署名からなり、 `ヘッダ.ペイロード.署名` となる
- JWTのヘッダは、暗号アルゴリズムとトークンタイプが記載されている
- JWTのペイロードは トークン発行主、クライアントID、JWT発行時刻や識別子が記載されている
- JWTの署名は、署名なしトークン(`ヘッダ.ペイロード`)をBase64URLエンコードしたものに署名した結果
- jwt.ioは、JWTのエンコード、デコードを利用できる

## Railsにおける認証・認可
- secret_key_baseは、Cookieの暗号化に使われる文字列のことで、セッション管理でクッキーを利用する際に使う
- omniauth

## その他用語
- SSO(シングルサインオン)は、1度の認証で、以後その認証に紐付けられているアプリケーションの認証無しで利用できる仕組みのこと
- Locationレスポンスヘッダーはリダイレクト先のURLを示す
- HTTPレスポンスのクエリは、?で区切られたキーと値のペアのこと
- HTTPレスポンスのフラグメントはは、#で区切られたリソースのアンカーのこと
- Authorization リクエストヘッダーは、ユーザーエージェントがサーバーから認証を受けるための証明書を示す
- 公開鍵暗号方式(RSA)は、受信側が公開鍵と秘密鍵を生成し、送信側が公開鍵を使い暗号化し、受信側が秘密鍵を使って復号化する方式のこと
- 共通鍵暗号方式(Advanced Encryption Standard, AES)は、送信側と受信側が同一の共通鍵を使い、暗号化、復号化する方式のこと
- 電子署名は、公開鍵暗号方式を応用した証明方法であり、署名者がが秘密鍵を使って暗号化し、受信側が公開鍵を使って複合する方法で、秘密鍵の特定によって署名者を特定できる
